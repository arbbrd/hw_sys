# Дипломная работа «Системный администратор» - arb

Ключевая задача — разработать отказоустойчивую инфраструктуру для сайта, включающую мониторинг, сбор логов и резервное копирование основных данных. Инфраструктура должна размещаться в Yandex Cloud и отвечать минимальным стандартам безопасности.

## Инфраструктура (Terraform + Ansible)

- Инструменты: Terraform для облачных ресурсов, Ansible для настройки ВМ.  
- Безопасность: Токены и ключи не коммитятся в Git (используются переменные окружения).  
- Внешние IP только у необходимых сервисов (бастион, балансировщик, Kibana, Zabbix).  
- Настройка Security Groups.  
- Конфигурация ВМ: Минимальная (2 vCPU, 2-4 ГБ RAM, 10 ГБ HDD, прерываемая).  
- Имена ВМ в Ansible: Использовать FQDN.  

## Сеть (VPC)

- Создать один VPC с публичными и приватными подсетями.  
- Публичная подсеть: Бастион, балансировщик, Kibana, Zabbix (опционально frontend).  
- Приватная подсеть: Веб-серверы, Elasticsearch, Zabbix server (если разделён).  
- Бастион (Jump Host): Одна ВМ с публичным IP и открытым только SSH-портом. Через неё доступ ко всем приватным ВМ.  
- NAT-шлюз: Для исходящего интернет-трафика приватных ВМ.  

## Веб-сайт (Nginx)

- Серверы: 2 идентичные ВМ в разных зонах доступности, без внешних IP.
- Установка: Nginx + статичный сайт.
- Балансировщик (Application Load Balancer):
   + Target Group с двумя веб-ВМ.
   + Backend Group с Health Check (HTTP:80, путь /).
   + HTTP Router (путь / → Backend Group).
   + ALB (listener на порту 80, тип auto).
- Тест: curl -v <публичный_IP_балансировщика>

## Мониторинг (Zabbix)

- Сервер Zabbix: ВМ в публичной подсети (или приватной с frontend отдельно).  
- Агенты: Установить Zabbix Agent на все ВМ (веб, Elasticsearch, Kibana, сам Zabbix).  
- Настройка: Агенты отправляют метрики на Zabbix Server.  
- Дашборды: Создать по принципу USE (Utilization, Saturation, Errors) для CPU, RAM, дисков, сети, HTTP-запросов.  
- Пороги (Tresholds): Настроить алерты для ключевых метрик.  

## Логи (ELK Stack)

- Elasticsearch: ВМ в приватной подсети.  
- Filebeat: Установить на веб-серверы. Настроить отправку access.log и error.log nginx в Elasticsearch.  
- Kibana: ВМ в публичной подсети. Настроить соединение с Elasticsearch для визуализации логов.  

## Резервное копирование

- Снапшоты: Настроить ежедневное создание snapshot дисков всех ВМ через Yandex Cloud API/Terraform.  
- Срок хранения: Ограничить 7 днями (автоматическое удаление старых).  

## Дополнительно (опционально)

- Zabbix high availability: Разделение на frontend (публичный), server (приватный), БД (Managed PostgreSQL).  
- Instance Group: Вместо фиксированных веб-ВМ — группа с автоскейлингом (min 1, max 3 на зону).  
- Расширенный сбор логов: Filebeat на всех ВМ для сбора логов сервисов (Elasticsearch, Kibana, Zabbix).  
- HTTPS: Выпуск сертификата (Certificate Manager), перенастройка балансировщика на HTTPS → HTTP.  

## Критерии сдачи

- Инфраструктура соответствует минимальным требованиям.  
- Предоставлен доступ (или скриншоты/вывод команд) к:
   + Сайту (через балансировщик).
   + Kibana.
   + Zabbix.
   + Код в GitHub-репозитории с понятным описанием.
   + Доступ к репозиторию открыт для проверяющего.


# Выполнение

## Инфраструктура (Terraform)

Создаём всю сеть и машины одним махом.

- Сеть: VPC, подсети, NAT-шлюз, Security Groups.  
- Все ВМ: Бастион, 2 веб-сервера, Zabbix, Elasticsearch, Kibana.  
- Балансировщик: ALB с публичным IP и настройками.  
- Бэкапы: Настройка снапшотов для всех дисков.  

## Настройка (Ansible)

Устанавливаем и настраиваем всё ПО.

- Бастион: Ставим Ansible.  
- Веб-серверы: Nginx + сайт, Zabbix Agent, Filebeat.  
- Zabbix: Сервер + фронтенд + агент + настройка (хосты, дашборды).  
- ELK: Elasticsearch + Kibana + автоматическое создание индексов.  


Структура проекта примерно такая:

```
dplm_arb/
├── terraform/
│   ├── main.tf
│   ├── variables.tf
│   ├── terraform.tfvars
│   └── outputs.tf
├── ansible/
│   ├── ansible.cfg
│   ├── inventory.yml
│   └── playbooks/
│       └── site.yml
├── static_site/
│   └── index.html
```


sudo wget https://hashicorp-releases.yandexcloud.net/terraform/1.14.4/terraform_1.14.4_linux_amd64.zip
sudo unzip terraform_1.14.4_linux_amd64.zip -d /usr/local/bin/